-- [[ CONFIG ]] --
local WHITELIST_URL = "https://raw.githubusercontent.com/jamalyoung373739-bit/whitelist.json/main/json"
local HUB_URL = "https://raw.githubusercontent.com/jamalyoung373739-bit/Pharmacii1f/main/Finale"

-- [[ 1. GET ROBLOX USERNAME ]] --
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Username = LocalPlayer.Name
local HttpService = game:GetService("HttpService")

-- [[ 2. FORCE COPY & NOTIFY ]] --
pcall(function() 
    if setclipboard then setclipboard(Username) end
    if toclipboard then toclipboard(Username) end
end)

print("------------------------------------------")
print("PHARMACII HUB AUTHENTICATION")
print("AUTHENTICATING USER: " .. Username)
print("------------------------------------------")

pcall(function()
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "PHARMACII",
        Text = "Checking Whitelist...",
        Duration = 5,
        Icon = "rbxassetid://6031154871" 
    })
end)

-- [[ 3. AUTHENTICATION LOGIC ]] --
local function Authenticate()
    local success, response = pcall(function()
        return game:HttpGet(WHITELIST_URL .. "?t=" .. os.time())
    end)

    if success then
        local decodeSuccess, whitelist = pcall(function() return HttpService:JSONDecode(response) end)
        
        if not decodeSuccess then
            warn("PHARMACII: JSON Error. Check your GitHub file format.")
            return
        end

        local isWhitelisted = false

        -- [[ UPDATED CHECKER ]] --
        for _, entry in pairs(whitelist) do
            -- 1. Split the entry at the "|" symbol to separate Name from Note
            local namePart = string.split(entry, "|")[1]
            
            -- 2. Trim spaces (Turns "User " into "User")
            if namePart then
                namePart = namePart:match("^%s*(.-)%s*$")
                
                -- 3. Check if it matches
                if namePart == Username then
                    isWhitelisted = true
                    break
                end
            end
        end

        if isWhitelisted then
            print("PHARMACII: ACCESS GRANTED. Loading Hub...")
            local hubSuccess, hubCode = pcall(function() return game:HttpGet(HUB_URL) end)
            
            if hubSuccess then
                loadstring(hubCode)()
            else
                warn("PHARMACII: Failed to fetch script.")
            end
        else
            warn("PHARMACII: ACCESS DENIED.")
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "ACCESS DENIED",
                Text = "Username copied. Send to Amiri.",
                Duration = 5
            })
        end
    else
        warn("PHARMACII: Connection Error.")
    end
end

task.spawn(Authenticate)
