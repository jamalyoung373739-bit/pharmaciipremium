-- [[ CONFIG ]] --
local WHITELIST_URL = "https://raw.githubusercontent.com/jamalyoung373739-bit/whitelist.json/main/json"
local HUB_URL = "https://raw.githubusercontent.com/jamalyoung373739-bit/Pharmacii1f/main/Finale"

-- [[ 1. GET ROBLOX USERNAME ]] --
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Username = LocalPlayer.Name

-- [[ 2. FORCE COPY & NOTIFY ]] --
pcall(function() 
    if setclipboard then setclipboard(Username) end
    if toclipboard then toclipboard(Username) end
end)

print("------------------------------------------")
print("PHARMACII HUB AUTHENTICATION")
print("AUTHENTICATING USER: " .. Username)
print("------------------------------------------")

pcall(function()
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "PHARMACII",
        Text = "Checking Whitelist...",
        Duration = 5,
        Icon = "rbxassetid://6031154871" 
    })
end)

-- [[ 3. AUTHENTICATION LOGIC (RAW TEXT FIX) ]] --
local function Authenticate()
    -- Fetch the raw text from the website
    local success, response = pcall(function()
        return game:HttpGet(WHITELIST_URL .. "?t=" .. os.time())
    end)

    if success then
        local isWhitelisted = false
        
        -- Loop through every line of text in the GitHub file
        for line in response:gmatch("[^\r\n]+") do
            -- 1. Remove any extra spaces or quotes (Sanitization)
            local cleanLine = line:gsub('["%[%],]', '') -- Removes ["], useful if you accidentally left JSON symbols
            
            -- 2. Split at the "|" to get just the name
            local namePart = string.split(cleanLine, "|")[1]

            -- 3. Trim whitespace around the name
            if namePart then
                namePart = namePart:match("^%s*(.-)%s*$")
                
                -- 4. Check match
                if namePart == Username then
                    isWhitelisted = true
                    break
                end
            end
        end

        if isWhitelisted then
            print("PHARMACII: ACCESS GRANTED. Loading Hub...")
            local hubSuccess, hubCode = pcall(function() return game:HttpGet(HUB_URL) end)
            
            if hubSuccess then
                loadstring(hubCode)()
            else
                warn("PHARMACII: Failed to load Hub script (404 or Network Error).")
                game:GetService("StarterGui"):SetCore("SendNotification", {
                    Title = "ERROR",
                    Text = "Failed to load script",
                    Duration = 5
                })
            end
        else
            warn("PHARMACII: ACCESS DENIED.")
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "ACCESS DENIED",
                Text = "Username copied. Send to Amiri.",
                Duration = 5
            })
        end
    else
        warn("PHARMACII: Connection Error (Could not reach GitHub).")
    end
end

task.spawn(Authenticate)
